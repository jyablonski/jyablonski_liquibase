<?xml version="1.1" encoding="UTF-8"?>
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:pro="http://www.liquibase.org/xml/ns/pro"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd
        http://www.liquibase.org/xml/ns/pro
        http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.4.xsd"
    >

    <changeSet author="jyablonski" id="create-rest-api-users-roles-insert">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from nba_prod.rest_api_users_roles;
            </sqlCheck>
        </preConditions>

        <sql>
            insert into nba_prod.rest_api_users_roles(username_id, role)
            select
                id as username_id,
                'Admin' as role
            from nba_prod.rest_api_users
            where username = 'jyablonski';
        </sql>

        <sql>
            -- this is the only 
            insert into nba_prod.rest_api_users_roles(username_id, role)
            select
                id as username_id,
                'Consumer' as role
            from nba_prod.rest_api_users
            where username != 'jyablonski';
        </sql>

        <rollback>
        <![CDATA[
            delete from nba_prod.rest_api_users_roles
            where date(created_at) < '2024-02-18';
        ]]>
        </rollback>
    </changeSet>
</databaseChangeLog>